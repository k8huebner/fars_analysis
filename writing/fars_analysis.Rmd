---

title: "fars_analysis"
author: "Kate Huebner"
date: "10/27/2017"
output: word_document
---

```{r global_Options, echo=TRUE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE,
                      warning = FALSE, error = FALSE)
```

```{r}
library(dplyr) 
library(tidyr) 
library(ggplot2)
library(ggthemes)
```

```{r}
load("../data/clean_fars.RData") 
#source("../R/fars_functions.R")
dim(clean_fars)
length(unique(clean_fars$unique_id))
summary(clean_fars)

```

```{r}
clean_fars %>%
mutate(year_cat = cut(year, breaks = c(1999, 2002, 2006, 2010),
labels = c("1999-2002", "2003-2006", "2007-2010"),
include.lowest = TRUE, right = TRUE)) %>% filter(!is.na(sex)) %>%
group_by(drug_type, sex, year_cat) %>% summarize(n_non_missing = sum(!is.na(positive_for_drug)),
positive_test = sum(positive_for_drug, na.rm = TRUE),
perc_positive = round(100 * positive_test / n_non_missing, 1)) %>% select(drug_type, sex, year_cat, perc_positive) %>%
unite(sex_year_cat, sex, year_cat) %>%
spread(sex_year_cat, perc_positive) %>%
knitr::kable(col.names = c("Drug type", "F 1999-2002", "F 2003-2006", "F 2007-2010", "M 1999-2002", "M 2003-2006",
                             "M 2007-2010"))
```
```{r}
#Figure 1: Prevalence of nonalcohol drugs in fatally injured drivers by year and age group
alcohol_data <- clean_fars %>% 
  select(unique_id, drug_type, year, agecat, positive_for_drug) %>% 
  filter(!is.na(positive_for_drug)) %>% 
  filter(!is.na(agecat)) %>% 
  group_by(agecat, year) %>% 
  summarize(total_count = n())
alcohol_data
  

nonalcohol_data <- clean_fars %>% 
  filter(!drug_type == "Alcohol") %>% 
  select(unique_id, drug_type, year, agecat, positive_for_drug) %>% 
  filter(!is.na(positive_for_drug)) %>%
  filter(positive_for_drug == TRUE) %>% 
  filter(!is.na(agecat)) %>% 
  group_by(agecat, year) %>% 
  summarize(count = n())
  #mutate (interest = agecat which positive_for_drug == "True") %>% 
  #want to add new column with total number of deaths per age group (regardless of alcohol usage)
  #summarize(number_per_age = n()) 

nonalcohol_data

joined <- nonalcohol_data %>% 
  left_join(alcohol_data) %>% 
  mutate(proportion = (count / total_count)*100)
  

joined

  
plot_1 <- joined %>% 
  ggplot(aes(x = year, y = proportion, color = agecat)) +
  geom_line() +
  labs(x = "Year", y = "Positive for Nonalcohol Drugs, %)", color = "Age") +
  scale_y_continuous(limits = c(0,30), breaks = 10, name = "") +
  theme_few() 
  
  
plot_1
  

```

```{r}
#figure 2
```
```{r}
#figure 3
```


```{r}
#Generating a table with percentages and 95% CIs by drug type for the years 1999 and 2010 using the perc_cis function

```

```{r}
drug_list <- c("Alcohol", "Nonalcohol", "Narcotic", "Depressant",
               "Stimulant", "Cannabinoid", "Other")
drug_trend_tests_log_reg <- lapply(drug_list, test_trend_log_reg)
drug_trend_tests_log_reg <- dplyr::bind_rows(drug_trend_tests_log_reg) %>%
  dplyr::mutate(drug = drug_list) %>%
  dplyr::select(drug, "z value", "Pr(>|z|)")
drug_trend_tests_log_reg %>% 
  knitr::kable(digits = 2)
```

